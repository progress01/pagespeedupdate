<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSI 批次檢測工具 </title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* 模擬 Google Cloud 介面的樣式 (為了圖文教學) */
        .gcp-btn {
            background-color: #1a73e8; color: white; padding: 4px 12px; border-radius: 4px; 
            font-size: 12px; font-weight: 500; display: inline-flex; align-items: center; gap: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .gcp-input {
            border: 1px solid #dadce0; background: #fff; padding: 4px 8px; border-radius: 4px;
            color: #3c4043; font-size: 12px; display: inline-block; min-width: 150px;
        }
        .gcp-box {
            background: #f8f9fa; border: 1px solid #dadce0; padding: 8px; border-radius: 4px;
            margin-top: 4px; margin-bottom: 4px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- 1. API Key 完整圖文教學彈窗 ---
        const GuideModal = ({ onClose }) => {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="sticky top-0 bg-white p-4 border-b border-gray-100 flex justify-between items-center z-10">
                            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <Icon name="book-open" className="text-blue-600"/>
                                API Key 申請與費用說明
                            </h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded-full text-gray-500">
                                <Icon name="x" size={20}/>
                            </button>
                        </div>
                        
                        <div className="p-6 space-y-8">
                            
                            {/* 費用與額度警告 */}
                            <div className="bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r-lg">
                                <h4 className="font-bold text-orange-800 flex items-center gap-2 mb-2">
                                    <Icon name="alert-triangle" size={18}/> 關於費用與限制 (必讀)
                                </h4>
                                <ul className="list-disc list-inside text-sm text-orange-800 space-y-1 ml-1">
                                    <li><strong>免費額度：</strong> Google PageSpeed Insights API 通常提供每日約 <strong>25,000 次</strong> 的免費查詢額度。</li>
                                    <li><strong>超出限制：</strong> 若短時間大量查詢，Google 會回傳 <code>429 Too Many Requests</code> 錯誤。</li>
                                    <li><strong>潛在費用：</strong> 若綁定付費專案，請務必至 GCP 後台確認配額。</li>
                                    <li>本工具僅為介面，實際 API 呼叫由您的瀏覽器發出。</li>
                                </ul>
                            </div>

                            {/* 申請教學步驟 (完整圖文模擬) */}
                            <div>
                                <h4 className="font-bold text-gray-700 mb-4 flex items-center gap-2 border-b pb-2">
                                    <Icon name="key" size={18} className="text-blue-600"/>
                                    如何申請 API Key (圖文模擬教學)
                                </h4>
                                
                                <div className="space-y-6">
                                    {/* Step 1 */}
                                    <div className="flex gap-4">
                                        <div className="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">1</div>
                                        <div className="flex-1">
                                            <p className="font-bold text-sm mb-1">前往 Google Cloud Console</p>
                                            <p className="text-xs text-gray-500 mb-2">登入您的 Google 帳號並建立一個新專案。</p>
                                            <a href="https://console.cloud.google.com/" target="_blank" className="text-blue-600 underline text-xs flex items-center gap-1">
                                                前往 Console <Icon name="external-link" size={10}/>
                                            </a>
                                        </div>
                                    </div>

                                    {/* Step 2 */}
                                    <div className="flex gap-4">
                                        <div className="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">2</div>
                                        <div className="flex-1">
                                            <p className="font-bold text-sm mb-2">啟用 PageSpeed API</p>
                                            <div className="text-xs text-gray-600 mb-2">在上方搜尋欄輸入 "PageSpeed"，點選 <strong>PageSpeed Insights API</strong>。</div>
                                            <div className="gcp-box">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <span className="text-xs font-bold text-gray-700">PageSpeed Insights API</span>
                                                </div>
                                                <span className="gcp-btn">啟用 (Enable)</span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Step 3 */}
                                    <div className="flex gap-4">
                                        <div className="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">3</div>
                                        <div className="flex-1">
                                            <p className="font-bold text-sm mb-2">建立憑證 (Credentials)</p>
                                            <div className="text-xs text-gray-600 mb-2">啟用後，點選左側選單的「憑證」，然後建立 API 金鑰。</div>
                                            <div className="gcp-box flex flex-col gap-2">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-blue-600 font-bold text-xs">+ 建立憑證</span>
                                                    <span className="text-gray-400">▼</span>
                                                </div>
                                                <div className="bg-white border shadow-sm p-2 rounded w-32">
                                                    <span className="block text-xs text-gray-700">API 金鑰</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Step 4 */}
                                    <div className="flex gap-4">
                                        <div className="flex-shrink-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">4</div>
                                        <div className="flex-1">
                                            <p className="font-bold text-sm mb-2">複製 Key 並貼上</p>
                                            <div className="text-xs text-gray-600 mb-2">您會獲得一串像是 <code className="bg-gray-100 px-1">AIzaSyD...</code> 的字串。</div>
                                            <div className="gcp-box flex items-center justify-between">
                                                <div className="gcp-input">AIzaSyDxxxxxxxxxxxx</div>
                                                <Icon name="copy" size={14} className="text-gray-500"/>
                                            </div>
                                            <p className="text-xs text-green-600 mt-2">將此字串貼回本工具的 API Key 欄位即可！</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div className="p-4 bg-gray-50 border-t border-gray-100 text-right">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-800 text-white rounded-lg text-sm hover:bg-black transition-colors">
                                我瞭解了
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 2. 智慧貼上完整圖文教學彈窗 ---
        const PasteGuideModal = ({ onClose }) => {
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="sticky top-0 bg-white p-4 border-b border-gray-100 flex justify-between items-center z-10">
                            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <Icon name="clipboard-check" className="text-green-600"/>
                                智慧貼上功能說明
                            </h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded-full text-gray-500">
                                <Icon name="x" size={20}/>
                            </button>
                        </div>
                        <div className="p-6 space-y-6">
                            <p className="text-sm text-gray-600">
                                不想手動輸入 <code>名稱, 網址</code> 嗎？<br/>
                                您可以直接複製 Excel 或筆記本中的「純網址列表」，我們會自動幫您格式化！
                            </p>

                            <div className="space-y-4">
                                {/* Step 1 */}
                                <div className="flex gap-3">
                                    <div className="mt-1"><Icon name="copy" size={20} className="text-blue-500"/></div>
                                    <div>
                                        <h4 className="font-bold text-sm text-gray-800">1. 複製純網址</h4>
                                        <p className="text-xs text-gray-500 mb-2">從您的資料來源選取並複製一整排網址。</p>
                                        <div className="bg-gray-100 p-2 rounded text-xs font-mono text-gray-600 border border-gray-200">
                                            www.google.com<br/>
                                            https://github.com<br/>
                                            yahoo.com.tw
                                        </div>
                                    </div>
                                </div>

                                {/* Arrow */}
                                <div className="flex justify-center text-gray-300"><Icon name="arrow-down" size={20}/></div>

                                {/* Step 2 */}
                                <div className="flex gap-3">
                                    <div className="mt-1"><Icon name="mouse-pointer-click" size={20} className="text-blue-500"/></div>
                                    <div>
                                        <h4 className="font-bold text-sm text-gray-800">2. 點擊「智慧貼上」按鈕</h4>
                                        <p className="text-xs text-gray-500">程式會自動補上 https 並抓取網域名稱。</p>
                                    </div>
                                </div>

                                {/* Arrow */}
                                <div className="flex justify-center text-gray-300"><Icon name="arrow-down" size={20}/></div>

                                {/* Step 3 */}
                                <div className="flex gap-3">
                                    <div className="mt-1"><Icon name="file-check" size={20} className="text-green-600"/></div>
                                    <div>
                                        <h4 className="font-bold text-sm text-gray-800">3. 完成！自動轉換格式</h4>
                                        <div className="bg-blue-50 p-2 rounded text-xs font-mono text-blue-800 border border-blue-100">
                                            google.com, https://www.google.com<br/>
                                            github.com, https://github.com<br/>
                                            yahoo.com.tw, https://yahoo.com.tw
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 bg-gray-50 border-t border-gray-100 text-right">
                            <button onClick={onClose} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors">懂了，開始使用</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 3. 輸入格式說明彈窗 (支援中文名稱) ---
        const InputFormatModal = ({ onClose, onLoadSample }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onClick={onClose}>
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 relative" onClick={e => e.stopPropagation()}>
                    <button onClick={onClose} className="absolute top-4 right-4"><Icon name="x"/></button>
                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="edit-3" className="text-purple-600"/> 自訂名稱格式說明</h3>
                    
                    <div className="space-y-4 text-sm text-gray-600">
                        <p>如果您想在報告中顯示中文名稱或專案代號，請使用以下格式：</p>
                        
                        <div className="bg-purple-50 border border-purple-100 p-3 rounded-lg">
                            <code className="text-purple-700 font-bold block mb-2">名稱, 網址</code>
                            <ul className="text-xs space-y-1 text-gray-500 list-disc list-inside">
                                <li>使用 <strong>半形逗號 ( , )</strong> 分隔</li>
                                <li>一行一筆資料</li>
                            </ul>
                        </div>

                        <div>
                            <p className="font-bold text-gray-700 mb-1">範例：</p>
                            <div className="bg-gray-100 p-3 rounded text-xs font-mono text-gray-700 leading-relaxed">
                                行政院官網, https://www.ey.gov.tw<br/>
                                台積電 TSMC, https://www.tsmc.com<br/>
                                專案A-測試站, http://dev.example.com
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 flex justify-end gap-3">
                        <button onClick={() => { onLoadSample(); onClose(); }} className="px-4 py-2 bg-purple-100 text-purple-700 hover:bg-purple-200 rounded text-sm font-bold flex items-center gap-2">
                            <Icon name="download" size={14}/> 直接載入範例試試
                        </button>
                        <button onClick={onClose} className="px-4 py-2 bg-gray-800 text-white rounded text-sm hover:bg-black">關閉</button>
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [inputData, setInputData] = useState('');
            const [apiKey, setApiKey] = useState('');
            const [results, setResults] = useState([]);
            const [isScanning, setIsScanning] = useState(false);
            const [progress, setProgress] = useState(0);
            const [currentTask, setCurrentTask] = useState('');
            
            // Modal States
            const [showApiGuide, setShowApiGuide] = useState(false);
            const [showPasteGuide, setShowPasteGuide] = useState(false);
            const [showFormatGuide, setShowFormatGuide] = useState(false);

            const abortControllerRef = useRef(null);

            // 預設載入一個簡單範例
            useEffect(() => {
                setInputData(`Google搜尋, https://www.google.com\nGitHub代碼, https://github.com`);
            }, []);

            // 功能：載入中文範例
            const loadSampleData = () => {
                const sample = `行政院, https://www.ey.gov.tw\n台積電, https://www.tsmc.com\n博客來, https://www.books.com.tw\nGoogle搜尋, https://www.google.com`;
                setInputData(sample);
            };

            const handleSmartPaste = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (!text.trim()) { alert("剪貼簿是空的！"); return; }
                    const processedLines = text.split(/\r?\n/).map(line => {
                        line = line.trim();
                        if (!line) return null;
                        if (line.includes(',')) return line;
                        try {
                            const urlStr = line.startsWith('http') ? line : `https://${line}`;
                            const urlObj = new URL(urlStr);
                            const domain = urlObj.hostname.replace('www.', '');
                            return `${domain}, ${urlStr}`;
                        } catch (e) { return `網站, ${line}`; }
                    }).filter(Boolean);
                    setInputData(processedLines.join('\n'));
                } catch (err) { alert("無法讀取剪貼簿，請確認瀏覽器權限或手動貼上。"); }
            };

            const handleClear = () => { if (window.confirm("確定要清空嗎？(Key 會保留)")) { setInputData(''); setResults([]); setProgress(0); setCurrentTask(''); } };
            
            const parseInput = () => inputData.split('\n').filter(l => l.trim()).map(l => {
                const parts = l.split(',');
                if (parts.length >= 2) return { name: parts[0].trim(), url: parts.slice(1).join(',').trim() };
                const rawUrl = l.trim();
                let name = '網站';
                try { name = new URL(rawUrl.startsWith('http') ? rawUrl : `https://${rawUrl}`).hostname; } catch(e){}
                return { name, url: rawUrl };
            });

            // 核心 Fetch (保持重試機制)
            const fetchPSI = async (url, strategy, key, signal) => {
                let targetUrl = url.startsWith('http') ? url : `https://${url}`;
                let apiUrl = `https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${encodeURIComponent(targetUrl)}&strategy=${strategy}`;
                apiUrl += `&category=PERFORMANCE&category=ACCESSIBILITY&category=BEST_PRACTICES&category=SEO`;
                if (key) apiUrl += `&key=${key}`;
                const maxRetries = 2; let attempt = 0;
                while (attempt <= maxRetries) {
                    try {
                        const response = await fetch(apiUrl, { signal });
                        if (response.status === 429) { attempt++; if(attempt>maxRetries) throw new Error("429 Too Many Requests"); await new Promise(r=>setTimeout(r, 2000*attempt)); continue; }
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return await response.json();
                    } catch (e) { if(e.name==='AbortError'||e.message.includes('429')) throw e; attempt++; if(attempt>maxRetries) throw e; await new Promise(r=>setTimeout(r, 1500)); }
                }
            };

            // 加速版檢測邏輯 (並行處理) + API Key 防呆
            const startScan = async () => {
                // 防呆：沒 Key 警告
                if (!apiKey) {
                    if (!window.confirm("⚠️ 警告：未輸入 API Key！\n\n這極易導致並行檢測失敗 (429 Error)。\n建議先去申請免費 Key。\n\n確定要強行繼續嗎？")) return;
                }

                const sites = parseInput();
                if (sites.length === 0) { alert("請輸入網址"); return; }
                setIsScanning(true); setResults([]); setProgress(0); abortControllerRef.current = new AbortController();
                const total = sites.length; const newRes = [];
                try {
                    for (let i = 0; i < total; i++) {
                        const site = sites[i];
                        const res = { name: site.name, url: site.url, mobile: null, desktop: null, status: 'pending' };
                        setCurrentTask(`[${i+1}/${total}] ${site.name} 檢測中 (並行加速)...`);
                        
                        // Promise.allSettled 並行發送請求
                        const [m, d] = await Promise.allSettled([
                            fetchPSI(site.url, 'mobile', apiKey, abortControllerRef.current.signal),
                            fetchPSI(site.url, 'desktop', apiKey, abortControllerRef.current.signal)
                        ]);
                        
                        res.mobile = m.status === 'fulfilled' ? extractScores(m.value) : { error: true, msg: m.reason.message };
                        res.desktop = d.status === 'fulfilled' ? extractScores(d.value) : { error: true, msg: d.reason.message };
                        res.status = 'success'; newRes.push(res); setResults([...newRes]); setProgress(Math.round(((i+1)/total)*100));
                        
                        // 冷卻時間 (有Key快一點，沒Key慢一點)
                        if(i<total-1) await new Promise(r => setTimeout(r, apiKey ? 1000 : 3000));
                    }
                } catch (e) { if (e.name !== 'AbortError') alert(e.message); } finally { setIsScanning(false); setCurrentTask('完成'); }
            };

            const stopScan = () => { if(abortControllerRef.current) abortControllerRef.current.abort(); setIsScanning(false); };
            
            const extractScores = (d) => d?.lighthouseResult?.categories ? { performance: Math.round(d.lighthouseResult.categories.performance.score*100), accessibility: Math.round(d.lighthouseResult.categories.accessibility.score*100), bestPractices: Math.round(d.lighthouseResult.categories['best-practices'].score*100), seo: Math.round(d.lighthouseResult.categories.seo.score*100) } : { error: true };
            
            const getReportUrl = (url) => `https://pagespeed.web.dev/analysis?url=${encodeURIComponent(url.startsWith('http') ? url : `https://${url}`)}`;
            
            const exportExcel = () => { 
                if(typeof XLSX==='undefined') return; 
                const flatData = results.map(r => ({
                    '網站名稱': r.name, 
                    '網址': r.url, 
                    '官方報告連結': getReportUrl(r.url),
                    'M-效能': r.mobile?.error ? 'Error' : r.mobile?.performance,
                    'M-無障礙': r.mobile?.error ? 'Error' : r.mobile?.accessibility,
                    'M-最佳': r.mobile?.error ? 'Error' : r.mobile?.bestPractices,
                    'M-SEO': r.mobile?.error ? 'Error' : r.mobile?.seo,
                    'D-效能': r.desktop?.error ? 'Error' : r.desktop?.performance,
                    'D-無障礙': r.desktop?.error ? 'Error' : r.desktop?.accessibility,
                    'D-最佳': r.desktop?.error ? 'Error' : r.desktop?.bestPractices,
                    'D-SEO': r.desktop?.error ? 'Error' : r.desktop?.seo,
                }));
                const ws=XLSX.utils.json_to_sheet(flatData); 
                const wb=XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb,ws,"PSI Reports"); 
                XLSX.writeFile(wb, `PSI_Report_${new Date().toISOString().slice(0,10)}.xlsx`); 
            };
            
            const getScoreColor = (s) => s>=90?'text-green-600 font-bold':s>=50?'text-orange-500 font-bold':'text-red-600 font-bold';
            const ScoreCell = ({val}) => (val?.error) ? <span className="text-red-500 text-[10px]" title={val.msg}>失敗</span> : (val===undefined) ? <span className="text-gray-300">-</span> : <span className={getScoreColor(val)}>{val}</span>;

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-20">
                    {/* 三大教學彈窗掛載 */}
                    {showApiGuide && <GuideModal onClose={() => setShowApiGuide(false)} />}
                    {showPasteGuide && <PasteGuideModal onClose={() => setShowPasteGuide(false)} />}
                    {showFormatGuide && <InputFormatModal onClose={() => setShowFormatGuide(false)} onLoadSample={loadSampleData} />}

                    <header className="bg-indigo-600 text-white p-6 shadow-lg">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex gap-3 items-center"><Icon name="zap" className="w-8 h-8 text-yellow-300"/><h1 className="text-2xl font-bold">PSI 極速批次檢測</h1></div>
                            <div className="text-sm opacity-80">旗艦完整版 ⚡</div>
                        </div>
                    </header>
                    
                    <main className="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-2">
                        <div className="lg:col-span-4 space-y-4">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                                <h2 className="text-base font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon name="settings-2" size={18} className="text-indigo-600"/> 設定與輸入</h2>
                                
                                <div className="mb-4">
                                    <div className="flex justify-between items-center mb-1">
                                        <label className="text-xs font-bold text-slate-500 uppercase">Google API Key</label>
                                        <button onClick={() => setShowApiGuide(true)} className="text-[10px] text-indigo-600 underline flex gap-1">
                                            <Icon name="help-circle" size={12}/> 如何申請？費用說明
                                        </button>
                                    </div>
                                    <div className="relative">
                                        <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="建議輸入 Key 以加速" className="w-full bg-slate-50 border border-slate-300 rounded pl-3 pr-8 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"/>
                                        <div className="absolute right-2 top-2.5 text-slate-400"><Icon name="key" size={14}/></div>
                                    </div>
                                </div>

                                <div className="mb-2">
                                    {/* 格式說明按鈕 */}
                                    <div className="flex justify-between items-end mb-1">
                                        <div className="flex items-center gap-1">
                                            <label className="text-xs font-bold text-slate-500 uppercase">網站列表</label>
                                            <button onClick={() => setShowFormatGuide(true)} className="text-slate-400 hover:text-indigo-600 transition-colors" title="格式說明"><Icon name="help-circle" size={14}/></button>
                                        </div>
                                        <div className="flex gap-1">
                                            <button onClick={loadSampleData} className="text-[10px] bg-purple-50 text-purple-600 px-2 py-1 rounded hover:bg-purple-100 flex gap-1 font-bold border border-purple-100" title="載入中文範例"><Icon name="download" size={12}/> 載入範例</button>
                                            <button onClick={handleClear} className="text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded hover:bg-red-100 flex gap-1 border border-red-100"><Icon name="trash-2" size={12}/> 清空</button>
                                        </div>
                                    </div>
                                    
                                    <textarea value={inputData} onChange={(e) => setInputData(e.target.value)} className="w-full h-60 border border-slate-300 rounded px-3 py-2 text-xs font-mono focus:ring-2 focus:ring-indigo-500 resize-none bg-slate-50 leading-relaxed" placeholder="名稱, 網址"/>
                                    
                                    {/* 智慧貼上 */}
                                    <div className="flex justify-between items-center mt-2">
                                        <div className="text-[10px] text-slate-400">{inputData ? inputData.split('\n').filter(l=>l.trim()).length : 0} 筆資料</div>
                                        <div className="flex">
                                            <button onClick={handleSmartPaste} className="text-[10px] bg-indigo-50 text-indigo-600 pl-2 pr-1 py-1 rounded-l hover:bg-indigo-100 flex items-center gap-1 font-bold border border-indigo-100 border-r-0"><Icon name="clipboard-paste" size={12}/> 智慧貼上</button>
                                            <button onClick={() => setShowPasteGuide(true)} className="text-[10px] bg-indigo-50 text-indigo-400 px-1 py-1 rounded-r hover:bg-indigo-100 border border-indigo-100 border-l-0"><Icon name="help-circle" size={12}/></button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="mt-4 pt-4 border-t border-slate-100">
                                    {!isScanning ? (
                                        <button onClick={startScan} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded font-bold text-sm flex justify-center gap-2 shadow-md active:scale-[0.98]"><Icon name="play" size={16}/> 開始批次檢測</button>
                                    ) : (
                                        <button onClick={stopScan} className="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded font-bold text-sm flex justify-center gap-2 shadow-md active:scale-[0.98]"><Icon name="stop-circle" size={18}/> 停止檢測</button>
                                    )}
                                </div>
                            </div>
                            
                            {isScanning && <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4"><div className="flex justify-between text-xs font-bold text-slate-600 mb-2"><span className="flex items-center gap-1"><Icon name="loader-2" size={12} className="animate-spin"/> 處理中...</span><span className="text-indigo-600">{progress}%</span></div><div className="w-full bg-slate-100 rounded-full h-2 mb-2"><div className="bg-indigo-600 h-2 rounded-full transition-all duration-500" style={{width: `${progress}%`}}></div></div><div className="text-[10px] text-slate-400 truncate text-center">{currentTask}</div></div>}
                        </div>
                        
                        <div className="lg:col-span-8 flex flex-col h-full min-h-[500px]">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-full overflow-hidden">
                                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-20"><h2 className="font-bold text-slate-700 flex items-center gap-2 text-sm"><Icon name="bar-chart-3" size={18} className="text-slate-400"/> 檢測報告</h2>{results.length > 0 && !isScanning && <button onClick={exportExcel} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-xs font-bold flex gap-1 shadow-sm"><Icon name="file-spreadsheet" size={14}/> 匯出 Excel</button>}</div>
                                <div className="flex-1 overflow-auto bg-slate-50 relative">
                                    {results.length === 0 ? <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-300"><Icon name="search-x" size={64} className="mb-4 opacity-50"/><p className="text-sm">等待開始...</p></div> : 
                                    <table className="w-full text-xs text-left border-collapse"><thead className="text-slate-500 bg-white sticky top-0 z-10 shadow-sm font-bold"><tr><th className="px-4 py-3 bg-slate-50 border-b w-[200px]">網站資訊</th><th colSpan="4" className="py-2 text-center border-b border-l bg-blue-50 text-blue-700">行動裝置</th><th colSpan="4" className="py-2 text-center border-b border-l bg-purple-50 text-purple-700">電腦</th></tr><tr className="border-b"><th className="bg-white"></th><th className="py-2 text-center w-12 border-l">效能</th><th className="py-2 text-center w-12">無障礙</th><th className="py-2 text-center w-12">最佳</th><th className="py-2 text-center w-12">SEO</th><th className="py-2 text-center w-12 border-l">效能</th><th className="py-2 text-center w-12">無障礙</th><th className="py-2 text-center w-12">最佳</th><th className="py-2 text-center w-12">SEO</th></tr></thead><tbody className="divide-y divide-slate-100 bg-white">{results.map((r, i) => <tr key={i} className="hover:bg-slate-50"><td className="px-4 py-3"><div className="font-bold text-slate-700 truncate" title={r.name}>{r.name}</div><div className="text-[10px] text-slate-400 truncate mb-1">{r.url}</div><a href={getReportUrl(r.url)} target="_blank" className="text-blue-600 bg-blue-50 px-1 rounded inline-flex items-center gap-1 border border-blue-100 hover:bg-blue-100">官方報告 <Icon name="external-link" size={10}/></a></td><td className="py-3 text-center border-l"><ScoreCell val={r.mobile?.error ? r.mobile : r.mobile?.performance}/></td><td className="py-3 text-center"><ScoreCell val={r.mobile?.error ? r.mobile : r.mobile?.accessibility}/></td><td className="py-3 text-center"><ScoreCell val={r.mobile?.error ? r.mobile : r.mobile?.bestPractices}/></td><td className="py-3 text-center"><ScoreCell val={r.mobile?.error ? r.mobile : r.mobile?.seo}/></td><td className="py-3 text-center border-l"><ScoreCell val={r.desktop?.error ? r.desktop : r.desktop?.performance}/></td><td className="py-3 text-center"><ScoreCell val={r.desktop?.error ? r.desktop : r.desktop?.accessibility}/></td><td className="py-3 text-center"><ScoreCell val={r.desktop?.error ? r.desktop : r.desktop?.bestPractices}/></td><td className="py-3 text-center"><ScoreCell val={r.desktop?.error ? r.desktop : r.desktop?.seo}/></td></tr>)}</tbody></table>}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
